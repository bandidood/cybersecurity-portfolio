# üî• Projet 02 : Configuration Pare-feu Enterprise

## üéØ Objectifs P√©dagogiques
- Configurer un pare-feu de niveau entreprise avec r√®gles avanc√©es
- Impl√©menter des politiques de s√©curit√© granulaires
- Mettre en place la supervision et l'alerting
- Optimiser les performances r√©seau avec QoS
- Documenter et auditer les configurations de s√©curit√©

## üìå Contexte Professionnel
Ce projet simule la configuration d'un pare-feu d'entreprise pour une organisation moyenne avec :
- **Segmentation r√©seau** : S√©paration stricte des environnements
- **Conformit√©** : Respect des standards PCI-DSS, SOX, RGPD
- **Performance** : Maintien de la productivit√© avec s√©curit√© renforc√©e
- **Audit** : Tra√ßabilit√© compl√®te pour les audits de s√©curit√©

## ‚úÖ Pr√©requis

### üß† Comp√©tences Techniques
- Administration r√©seau avanc√©e (VLAN, routage, NAT)
- Concepts de s√©curit√© r√©seau (ACL, VPN, IDS/IPS)
- Scripting bash/Python pour automatisation
- Connaissance des protocoles (TCP/IP, HTTPS, SSH)

### üõ†Ô∏è Infrastructure Requise
- Laboratoire de cybers√©curit√© op√©rationnel (Projet 01)
- pfSense ou √©quivalent (FortiGate, Cisco ASA)
- Outils de monitoring (PRTG, Nagios, ou custom)
- Machines de test dans diff√©rents segments

### üìã Standards de R√©f√©rence
- **NIST SP 800-53** : Contr√¥les de s√©curit√©
- **CIS Controls** : Bonnes pratiques de configuration
- **ISO 27001** : Management de la s√©curit√©
- **OWASP** : S√©curit√© des applications web

## üèóÔ∏è Architecture Cible

### üìä Segmentation R√©seau Enterprise
```
Internet (WAN)
    |
[Pare-feu Principal] - DMZ Public (172.16.10.0/24)
    |                     ‚îú‚îÄ‚îÄ Web Server Public
    |                     ‚îú‚îÄ‚îÄ Mail Server
    |                     ‚îî‚îÄ‚îÄ DNS Public
    |
‚îú‚îÄ‚îÄ LAN Management (10.1.0.0/24)
‚îÇ   ‚îú‚îÄ‚îÄ Domain Controllers
‚îÇ   ‚îú‚îÄ‚îÄ DHCP/DNS Servers
‚îÇ   ‚îî‚îÄ‚îÄ Management Tools
‚îÇ
‚îú‚îÄ‚îÄ LAN Users (10.2.0.0/24)
‚îÇ   ‚îú‚îÄ‚îÄ Workstations
‚îÇ   ‚îú‚îÄ‚îÄ Shared Resources
‚îÇ   ‚îî‚îÄ‚îÄ Print Servers
‚îÇ
‚îú‚îÄ‚îÄ LAN Servers (10.3.0.0/24)
‚îÇ   ‚îú‚îÄ‚îÄ Application Servers
‚îÇ   ‚îú‚îÄ‚îÄ Database Servers
‚îÇ   ‚îî‚îÄ‚îÄ File Servers
‚îÇ
‚îú‚îÄ‚îÄ DMZ Internal (172.16.20.0/24)
‚îÇ   ‚îú‚îÄ‚îÄ Web Apps Internal
‚îÇ   ‚îú‚îÄ‚îÄ API Gateways
‚îÇ   ‚îî‚îÄ‚îÄ Development Tools
‚îÇ
‚îú‚îÄ‚îÄ Security Zone (10.10.0.0/24)
‚îÇ   ‚îú‚îÄ‚îÄ SIEM Platform
‚îÇ   ‚îú‚îÄ‚îÄ Vulnerability Scanners
‚îÇ   ‚îú‚îÄ‚îÄ Backup Systems
‚îÇ   ‚îî‚îÄ‚îÄ Log Collectors
‚îÇ
‚îî‚îÄ‚îÄ Guest Network (192.168.200.0/24)
    ‚îú‚îÄ‚îÄ Visitor Access
    ‚îú‚îÄ‚îÄ BYOD Devices
    ‚îî‚îÄ‚îÄ IoT Devices
```

## üõ†Ô∏è Plan d'Action D√©taill√©

### Phase 1 : Planification et Design (Semaine 1)

#### √âtape 1.1 : Analyse des Besoins
```bash
# Audit de l'existant
nmap -sn 192.168.100.0/24  # D√©couverte r√©seau actuel
nmap -sS -O 192.168.100.1  # Fingerprinting pare-feu

# Documentation des flux
netstat -rn  # Table de routage
ss -tulpn    # Ports ouverts
```

#### √âtape 1.2 : D√©finition des Politiques
- **Principe du moindre privil√®ge** : Acc√®s minimum n√©cessaire
- **Segmentation par fonction** : Isolation des environnements
- **Contr√¥le applicatif** : Inspection deep packet
- **Logging exhaustif** : Tra√ßabilit√© compl√®te

#### √âtape 1.3 : Matrice de Flux Autoris√©s
| Source | Destination | Ports | Protocole | Justification |
|--------|-------------|-------|-----------|---------------|
| LAN Users | Internet | 80,443 | TCP | Navigation web |
| LAN Users | LAN Servers | 443,3389 | TCP | Acc√®s applications |
| DMZ Internal | LAN Servers | 1433,3306 | TCP | Base de donn√©es |
| Management | ALL | 22,3389,443 | TCP | Administration |
| Security Zone | ALL | 514,161 | UDP | Monitoring |

### Phase 2 : Configuration de Base (Semaine 2)

#### √âtape 2.1 : Interfaces et VLANs
```bash
# Configuration des interfaces (pfSense CLI)
/interface vlan add name=vlan-users vlan-id=10 interface=ether2
/interface vlan add name=vlan-servers vlan-id=20 interface=ether2
/interface vlan add name=vlan-dmz vlan-id=30 interface=ether3
/interface vlan add name=vlan-mgmt vlan-id=100 interface=ether4

# Attribution des adresses IP
/ip address add address=10.2.0.1/24 interface=vlan-users
/ip address add address=10.3.0.1/24 interface=vlan-servers
/ip address add address=172.16.20.1/24 interface=vlan-dmz
/ip address add address=10.1.0.1/24 interface=vlan-mgmt
```

#### √âtape 2.2 : R√®gles de Base
```bash
# R√®gles par d√©faut (pfSense)
# DENY ALL puis ALLOW sp√©cifique

# 1. Bloquer tout par d√©faut
pass quick on $wan_if inet proto tcp from any to ($wan_if) port ssh
block all

# 2. Autoriser management depuis r√©seau admin
pass in on $lan_mgmt inet proto tcp from $lan_mgmt:network to any port { ssh https }

# 3. Autoriser utilisateurs vers Internet (web)
pass in on $lan_users inet proto tcp from $lan_users:network to any port { http https }

# 4. Autoriser acc√®s contr√¥l√© vers serveurs
pass in on $lan_users inet proto tcp from $lan_users:network to $lan_servers:network port https
```

### Phase 3 : S√©curit√© Avanc√©e (Semaine 3)

#### √âtape 3.1 : Inspection Deep Packet
```bash
# Configuration IDS/IPS int√©gr√©
# Suricata avec r√®gles personnalis√©es

# Activation de l'inspection SSL
set security utm feature-profile web-filtering juniper-enhanced
set security utm feature-profile anti-virus juniper-express-engine

# R√®gles personnalis√©es pour d√©tection d'intrusion
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible data exfiltration"; \
    content:"confidential"; nocase; threshold:type limit, count 5, seconds 60; \
    classtype:policy-violation; sid:1000001;)
```

#### √âtape 3.2 : Contr√¥le Applicatif
```bash
# Application Control (pfSense + Suricata)
# Blocage d'applications non autoris√©es

# R√®gle pour bloquer P2P
block in quick proto tcp from any to any port { 6881:6999 4662 }

# Contr√¥le des r√©seaux sociaux (heures de bureau)
# Utilisation de pfBlockerNG avec listes de domaines
```

### Phase 4 : Monitoring et Optimisation (Semaine 4)

#### √âtape 4.1 : Configuration SIEM
```python
#!/usr/bin/env python3
# siem-log-parser.py - Analyse des logs pare-feu

import re
import json
from datetime import datetime
from collections import defaultdict

class FirewallLogAnalyzer:
    def __init__(self):
        self.blocked_ips = defaultdict(int)
        self.top_rules = defaultdict(int)
        self.alerts = []
    
    def parse_pfsense_log(self, log_line):
        """Parse une ligne de log pfSense"""
        pattern = r'(\w+\s+\d+\s+\d+:\d+:\d+).*rule (\d+).*: (\w+) (\d+\.\d+\.\d+\.\d+)\.(\d+) > (\d+\.\d+\.\d+\.\d+)\.(\d+)'
        match = re.search(pattern, log_line)
        
        if match:
            timestamp, rule_id, action, src_ip, src_port, dst_ip, dst_port = match.groups()
            return {
                'timestamp': timestamp,
                'rule_id': rule_id,
                'action': action,
                'src_ip': src_ip,
                'src_port': src_port,
                'dst_ip': dst_ip,
                'dst_port': dst_port
            }
        return None
    
    def analyze_threats(self, logs):
        """Analyse des menaces dans les logs"""
        for log_entry in logs:
            parsed = self.parse_pfsense_log(log_entry)
            if parsed and parsed['action'] == 'block':
                self.blocked_ips[parsed['src_ip']] += 1
                self.top_rules[parsed['rule_id']] += 1
                
                # D√©tection d'anomalies
                if self.blocked_ips[parsed['src_ip']] > 50:
                    self.alerts.append({
                        'type': 'Possible DDoS',
                        'src_ip': parsed['src_ip'],
                        'count': self.blocked_ips[parsed['src_ip']],
                        'timestamp': datetime.now().isoformat()
                    })
    
    def generate_report(self):
        """G√©n√©ration du rapport d'analyse"""
        report = {
            'timestamp': datetime.now().isoformat(),
            'top_blocked_ips': dict(sorted(self.blocked_ips.items(), 
                                         key=lambda x: x[1], reverse=True)[:10]),
            'most_triggered_rules': dict(sorted(self.top_rules.items(), 
                                               key=lambda x: x[1], reverse=True)[:10]),
            'security_alerts': self.alerts
        }
        
        return json.dumps(report, indent=2)

# Utilisation
analyzer = FirewallLogAnalyzer()
# analyzer.analyze_threats(firewall_logs)
# print(analyzer.generate_report())
```

## üîê Analyse des Risques & Contre-mesures

### ‚ö†Ô∏è Risques Identifi√©s et Mitigation

| Risque | Probabilit√© | Impact | Contre-mesure | KPI |
|--------|-------------|--------|---------------|-----|
| **DDoS/DoS** | √âlev√© | Critique | Rate limiting, GeoIP blocking | < 1% downtime |
| **Bypass de r√®gles** | Moyen | √âlev√© | Deep packet inspection, logs d√©taill√©s | 0 incident |
| **Configuration error** | Moyen | √âlev√© | Validation automatique, backups | < 30min restoration |
| **Performance degradation** | √âlev√© | Moyen | QoS, load balancing | < 100ms latency |
| **Compliance failure** | Faible | Critique | Audit automatique, documentation | 100% compliance |

### üõ°Ô∏è Contr√¥les de S√©curit√© Impl√©ment√©s

#### 1. Contr√¥les Pr√©ventifs
```bash
# Anti-spoofing
set security screen ids-option untrust-screen icmp ping-death
set security screen ids-option untrust-screen ip source-route-option
set security screen ids-option untrust-screen tcp syn-flood

# Geo-blocking
pfctl -t geoblock -T add 192.0.2.0/24  # Example block range

# Rate limiting
set firewall filter INPUT rule 10 protocol tcp destination-port 22 \
    recent name ssh_brute update seconds 60 hitcount 4 jump drop
```

#### 2. Contr√¥les D√©tectifs
```bash
# Monitoring en temps r√©el
tail -f /var/log/filter.log | grep -E "(block|deny)" | \
while read line; do
    echo "[ALERT] $(date): $line" | \
    logger -p local0.warning -t firewall_monitor
done

# Alertes automatiques
if [ $(grep -c "block" /var/log/filter.log | tail -100) -gt 20 ]; then
    echo "High block rate detected" | mail -s "Firewall Alert" admin@lab.local
fi
```

#### 3. Contr√¥les Correctifs
```bash
# Auto-ban des IPs malveillantes
#!/bin/bash
# auto-ban.sh
LOGFILE="/var/log/filter.log"
BANTIME="3600"  # 1 heure

# Analyser les tentatives de brute force
awk '/block.*ssh/ {print $13}' $LOGFILE | sort | uniq -c | \
while read count ip; do
    if [ $count -gt 10 ]; then
        pfctl -t bruteforce -T add $ip
        echo "$ip banned for $BANTIME seconds" | logger
        # Auto-unban apr√®s d√©lai
        (sleep $BANTIME; pfctl -t bruteforce -T delete $ip) &
    fi
done
```

## ‚úÖ Bonnes Pratiques Professionnelles

### üéØ Configuration Management
```bash
# Backup automatique des configurations
#!/bin/bash
# firewall-backup.sh

BACKUP_DIR="/backup/firewall/$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"

# Backup configuration pfSense
curl -k -u admin:password "https://192.168.100.1/diag_backup.php" \
    -d "download=download&donotbackuprrd=yes" \
    -o "$BACKUP_DIR/pfsense-config-$(date +%Y%m%d-%H%M%S).xml"

# Backup rules
pfctl -sr > "$BACKUP_DIR/firewall-rules-$(date +%Y%m%d).txt"

# Version control
cd "$BACKUP_DIR"
git add . && git commit -m "Firewall backup $(date)"

echo "‚úÖ Firewall backup completed: $BACKUP_DIR"
```

### üìä M√©triques et KPIs
```python
#!/usr/bin/env python3
# firewall-metrics.py - Calcul des m√©triques de performance

import psutil
import subprocess
import json
from datetime import datetime, timedelta

class FirewallMetrics:
    def __init__(self):
        self.metrics = {}
    
    def get_throughput(self):
        """Mesure du d√©bit r√©seau"""
        net_io = psutil.net_io_counters()
        return {
            'bytes_sent': net_io.bytes_sent,
            'bytes_recv': net_io.bytes_recv,
            'packets_sent': net_io.packets_sent,
            'packets_recv': net_io.packets_recv
        }
    
    def get_connection_stats(self):
        """Statistiques des connexions"""
        connections = psutil.net_connections()
        stats = {
            'established': 0,
            'listen': 0,
            'time_wait': 0
        }
        
        for conn in connections:
            if conn.status in stats:
                stats[conn.status] += 1
        
        return stats
    
    def get_rule_performance(self):
        """Performance des r√®gles de pare-feu"""
        try:
            result = subprocess.run(['pfctl', '-sr', '-v'], 
                                  capture_output=True, text=True)
            # Parser les statistiques des r√®gles
            rules_stats = {}
            for line in result.stdout.split('\n'):
                if 'Evaluations:' in line:
                    # Extraire les statistiques
                    pass
            return rules_stats
        except:
            return {}
    
    def calculate_sla_metrics(self):
        """Calcul des m√©triques SLA"""
        # Uptime
        uptime = subprocess.run(['uptime'], capture_output=True, text=True)
        
        # Latency moyenne
        ping_result = subprocess.run(['ping', '-c', '10', '8.8.8.8'], 
                                   capture_output=True, text=True)
        
        return {
            'uptime': uptime.stdout.strip(),
            'availability_percent': 99.9,  # √Ä calculer selon les logs
            'avg_latency_ms': 15.2,        # √Ä extraire du ping
            'packet_loss_percent': 0.0
        }
    
    def generate_dashboard_data(self):
        """Donn√©es pour tableau de bord"""
        self.metrics.update({
            'timestamp': datetime.now().isoformat(),
            'throughput': self.get_throughput(),
            'connections': self.get_connection_stats(),
            'sla': self.calculate_sla_metrics()
        })
        
        return json.dumps(self.metrics, indent=2)

# Utilisation pour monitoring continu
# metrics = FirewallMetrics()
# print(metrics.generate_dashboard_data())
```

## üìÇ Structure Git du Projet

```
02-firewall-configuration/
‚îú‚îÄ‚îÄ README.md                    # Ce fichier
‚îú‚îÄ‚îÄ CHANGELOG.md                 # Historique des modifications
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ network-diagram.png      # Sch√©ma r√©seau d√©taill√©
‚îÇ   ‚îú‚îÄ‚îÄ flow-matrix.xlsx         # Matrice des flux autoris√©s
‚îÇ   ‚îú‚îÄ‚îÄ compliance-mapping.md    # Mapping avec standards
‚îÇ   ‚îî‚îÄ‚îÄ troubleshooting.md       # Guide de d√©pannage
‚îú‚îÄ‚îÄ configs/
‚îÇ   ‚îú‚îÄ‚îÄ pfsense/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ firewall-rules.xml   # Configuration compl√®te
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nat-rules.xml        # R√®gles NAT
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vpn-config.xml       # Configuration VPN
‚îÇ   ‚îú‚îÄ‚îÄ suricata/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ suricata.yaml        # Config IDS/IPS
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ custom-rules.conf    # R√®gles personnalis√©es
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/
‚îÇ       ‚îú‚îÄ‚îÄ grafana-dashboard.json
‚îÇ       ‚îî‚îÄ‚îÄ prometheus-config.yml
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ deployment/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deploy-firewall.sh   # D√©ploiement automatique
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validate-config.sh   # Validation configuration
‚îÇ   ‚îú‚îÄ‚îÄ monitoring/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ firewall-metrics.py  # M√©triques performance
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ log-analyzer.py      # Analyse des logs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ alert-handler.sh     # Gestion des alertes
‚îÇ   ‚îú‚îÄ‚îÄ maintenance/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backup-config.sh     # Sauvegarde automatique
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ update-rules.sh      # Mise √† jour des r√®gles
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health-check.py      # V√©rification sant√©
‚îÇ   ‚îî‚îÄ‚îÄ testing/
‚îÇ       ‚îú‚îÄ‚îÄ connectivity-test.sh # Tests de connectivit√©
‚îÇ       ‚îú‚îÄ‚îÄ performance-test.py  # Tests de performance
‚îÇ       ‚îî‚îÄ‚îÄ security-audit.sh    # Audit de s√©curit√©
‚îú‚îÄ‚îÄ evidence/
‚îÇ   ‚îú‚îÄ‚îÄ screenshots/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pfsense-dashboard.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rule-configuration.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitoring-graphs.png
‚îÇ   ‚îú‚îÄ‚îÄ reports/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security-assessment.pdf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ performance-analysis.pdf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ compliance-audit.pdf
‚îÇ   ‚îî‚îÄ‚îÄ logs/
‚îÇ       ‚îú‚îÄ‚îÄ deployment.log       # Logs de d√©ploiement
‚îÇ       ‚îú‚îÄ‚îÄ performance.log      # Logs de performance
‚îÇ       ‚îî‚îÄ‚îÄ security-events.log  # √âv√©nements de s√©curit√©
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ unit/
    ‚îÇ   ‚îî‚îÄ‚îÄ test-rule-validation.py
    ‚îú‚îÄ‚îÄ integration/
    ‚îÇ   ‚îî‚îÄ‚îÄ test-end-to-end.sh
    ‚îî‚îÄ‚îÄ security/
        ‚îú‚îÄ‚îÄ penetration-test.py
        ‚îî‚îÄ‚îÄ vulnerability-scan.sh
```

## üìú R√©f√©rences et Standards

### üìö Documentation Technique
- **pfSense Official Docs** : [docs.netgate.com](https://docs.netgate.com/pfsense/)
- **Suricata User Guide** : [suricata.readthedocs.io](https://suricata.readthedocs.io/)
- **NIST SP 800-41** : Guidelines on Firewalls and Firewall Policy

### üîí Standards de S√©curit√©
- **NIST SP 800-53** : Security Controls for Federal Information Systems
- **CIS Controls v8** : [cisecurity.org](https://www.cisecurity.org/controls/)
- **ISO 27001:2013** : Information Security Management Systems
- **PCI DSS v4.0** : Payment Card Industry Data Security Standard

### üéì Formations Recommand√©es
- **SANS SEC503** : Intrusion Detection In-Depth
- **Cisco CCNA Security** : Implementing Network Security
- **pfSense Professional** : Netgate Training Program

---

## üéØ Livrables et Validation

### ‚úÖ Checklist de D√©ploiement
- [ ] Architecture r√©seau document√©e et approuv√©e
- [ ] R√®gles de pare-feu configur√©es et test√©es
- [ ] Monitoring et alerting op√©rationnels
- [ ] Documentation compl√®te r√©dig√©e
- [ ] Tests de performance valid√©s
- [ ] Audit de s√©curit√© r√©alis√©
- [ ] Proc√©dures de sauvegarde test√©es
- [ ] Formation √©quipe effectu√©e
- [ ] Plan de maintenance √©tabli
- [ ] Validation compliance effectu√©e

### üìä M√©triques de Succ√®s
- **S√©curit√©** : 0 incident de s√©curit√© critique
- **Performance** : < 100ms latence moyenne
- **Disponibilit√©** : 99.9% uptime minimum
- **Compliance** : 100% des contr√¥les valid√©s
- **Documentation** : 100% des proc√©dures couvertes

### üèÜ Comp√©tences D√©montr√©es
- **Architecture r√©seau s√©curis√©e** de niveau entreprise
- **Configuration avanc√©e de pare-feu** avec r√®gles granulaires
- **Monitoring et m√©triques** de performance s√©curit√©
- **Conformit√© r√©glementaire** et audit de s√©curit√©
- **Automatisation et scripts** pour maintenance
- **Documentation technique** professionnelle

---

**üîß Support Technique** : Pour assistance, consulter le guide de troubleshooting ou cr√©er une issue GitHub.

**üìà √âvolution** : Ce projet √©volue selon les retours et nouvelles menaces. V√©rifier r√©guli√®rement les mises √† jour.