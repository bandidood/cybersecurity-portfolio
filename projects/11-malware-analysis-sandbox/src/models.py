"""
Malware Analysis Sandbox - Data Models
Defines core data structures for malware samples and analysis results
"""

from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import List, Dict, Optional, Any
from pathlib import Path
import hashlib
import json


class SampleType(Enum):
    """Type of malware sample"""
    PE_EXECUTABLE = "pe_exe"
    PE_DLL = "pe_dll"
    ELF = "elf"
    MACH_O = "mach_o"
    SCRIPT = "script"
    DOCUMENT = "document"
    ARCHIVE = "archive"
    APK = "apk"
    UNKNOWN = "unknown"


class ThreatLevel(Enum):
    """Threat severity level"""
    BENIGN = "benign"
    SUSPICIOUS = "suspicious"
    MALICIOUS = "malicious"
    HIGHLY_MALICIOUS = "highly_malicious"


class AnalysisStatus(Enum):
    """Status of analysis"""
    PENDING = "pending"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    ERROR = "error"


@dataclass
class FileInfo:
    """File metadata information"""
    filename: str
    filepath: str
    size: int
    md5: str
    sha1: str
    sha256: str
    file_type: str
    mime_type: str
    magic: str
    created_at: datetime = field(default_factory=datetime.now)

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'filename': self.filename,
            'filepath': self.filepath,
            'size': self.size,
            'md5': self.md5,
            'sha1': self.sha1,
            'sha256': self.sha256,
            'file_type': self.file_type,
            'mime_type': self.mime_type,
            'magic': self.magic,
            'created_at': self.created_at.isoformat()
        }


@dataclass
class PEInfo:
    """Portable Executable (PE) file information"""
    architecture: str
    subsystem: str
    compilation_timestamp: Optional[datetime] = None
    entry_point: int = 0
    image_base: int = 0
    sections: List[Dict[str, Any]] = field(default_factory=list)
    imports: List[Dict[str, List[str]]] = field(default_factory=list)
    exports: List[str] = field(default_factory=list)
    resources: List[Dict[str, Any]] = field(default_factory=list)
    is_packed: bool = False
    packer: Optional[str] = None
    entropy: float = 0.0
    digital_signature: Optional[Dict[str, Any]] = None

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'architecture': self.architecture,
            'subsystem': self.subsystem,
            'compilation_timestamp': self.compilation_timestamp.isoformat() if self.compilation_timestamp else None,
            'entry_point': hex(self.entry_point),
            'image_base': hex(self.image_base),
            'sections': self.sections,
            'imports': self.imports,
            'exports': self.exports,
            'resources': self.resources,
            'is_packed': self.is_packed,
            'packer': self.packer,
            'entropy': self.entropy,
            'digital_signature': self.digital_signature
        }


@dataclass
class StringAnalysis:
    """Extracted strings and patterns"""
    ascii_strings: List[str] = field(default_factory=list)
    unicode_strings: List[str] = field(default_factory=list)
    urls: List[str] = field(default_factory=list)
    ips: List[str] = field(default_factory=list)
    emails: List[str] = field(default_factory=list)
    registry_keys: List[str] = field(default_factory=list)
    file_paths: List[str] = field(default_factory=list)
    crypto_constants: List[str] = field(default_factory=list)
    suspicious_strings: List[str] = field(default_factory=list)

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'ascii_strings': self.ascii_strings[:100],  # Limit for readability
            'unicode_strings': self.unicode_strings[:100],
            'urls': self.urls,
            'ips': self.ips,
            'emails': self.emails,
            'registry_keys': self.registry_keys,
            'file_paths': self.file_paths,
            'crypto_constants': self.crypto_constants,
            'suspicious_strings': self.suspicious_strings
        }


@dataclass
class YARAMatch:
    """YARA rule match result"""
    rule_name: str
    namespace: str
    tags: List[str]
    strings: List[Dict[str, Any]]
    meta: Dict[str, Any]

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'rule_name': self.rule_name,
            'namespace': self.namespace,
            'tags': self.tags,
            'strings': self.strings,
            'meta': self.meta
        }


@dataclass
class StaticAnalysisResult:
    """Results from static analysis"""
    file_info: FileInfo
    sample_type: SampleType
    pe_info: Optional[PEInfo] = None
    string_analysis: Optional[StringAnalysis] = None
    yara_matches: List[YARAMatch] = field(default_factory=list)
    threat_level: ThreatLevel = ThreatLevel.SUSPICIOUS
    threat_score: float = 0.0
    indicators: List[str] = field(default_factory=list)
    tags: List[str] = field(default_factory=list)
    family: Optional[str] = None
    analysis_time: float = 0.0

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'file_info': self.file_info.to_dict(),
            'sample_type': self.sample_type.value,
            'pe_info': self.pe_info.to_dict() if self.pe_info else None,
            'string_analysis': self.string_analysis.to_dict() if self.string_analysis else None,
            'yara_matches': [m.to_dict() for m in self.yara_matches],
            'threat_level': self.threat_level.value,
            'threat_score': self.threat_score,
            'indicators': self.indicators,
            'tags': self.tags,
            'family': self.family,
            'analysis_time': self.analysis_time
        }


@dataclass
class DynamicBehavior:
    """Dynamic analysis behavioral observations"""
    processes_created: List[Dict[str, Any]] = field(default_factory=list)
    files_created: List[str] = field(default_factory=list)
    files_modified: List[str] = field(default_factory=list)
    files_deleted: List[str] = field(default_factory=list)
    registry_keys_set: List[Dict[str, str]] = field(default_factory=list)
    registry_keys_deleted: List[str] = field(default_factory=list)
    network_connections: List[Dict[str, Any]] = field(default_factory=list)
    dns_queries: List[str] = field(default_factory=list)
    http_requests: List[Dict[str, Any]] = field(default_factory=list)
    mutexes_created: List[str] = field(default_factory=list)
    services_created: List[str] = field(default_factory=list)

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'processes_created': self.processes_created,
            'files_created': self.files_created,
            'files_modified': self.files_modified,
            'files_deleted': self.files_deleted,
            'registry_keys_set': self.registry_keys_set,
            'registry_keys_deleted': self.registry_keys_deleted,
            'network_connections': self.network_connections,
            'dns_queries': self.dns_queries,
            'http_requests': self.http_requests,
            'mutexes_created': self.mutexes_created,
            'services_created': self.services_created
        }


@dataclass
class MalwareSample:
    """Complete malware sample with analysis results"""
    sample_id: str
    file_info: FileInfo
    submitted_at: datetime = field(default_factory=datetime.now)
    status: AnalysisStatus = AnalysisStatus.PENDING
    static_analysis: Optional[StaticAnalysisResult] = None
    dynamic_behavior: Optional[DynamicBehavior] = None
    threat_level: ThreatLevel = ThreatLevel.SUSPICIOUS
    overall_score: float = 0.0
    malware_family: Optional[str] = None
    tags: List[str] = field(default_factory=list)
    notes: str = ""

    @classmethod
    def from_file(cls, filepath: str) -> 'MalwareSample':
        """Create sample from file path"""
        path = Path(filepath)

        # Read file
        with open(filepath, 'rb') as f:
            data = f.read()

        # Calculate hashes
        md5 = hashlib.md5(data).hexdigest()
        sha1 = hashlib.sha1(data).hexdigest()
        sha256 = hashlib.sha256(data).hexdigest()

        # Create file info
        file_info = FileInfo(
            filename=path.name,
            filepath=str(path.absolute()),
            size=len(data),
            md5=md5,
            sha1=sha1,
            sha256=sha256,
            file_type="unknown",
            mime_type="unknown",
            magic="unknown"
        )

        return cls(
            sample_id=sha256[:16],
            file_info=file_info
        )

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'sample_id': self.sample_id,
            'file_info': self.file_info.to_dict(),
            'submitted_at': self.submitted_at.isoformat(),
            'status': self.status.value,
            'static_analysis': self.static_analysis.to_dict() if self.static_analysis else None,
            'dynamic_behavior': self.dynamic_behavior.to_dict() if self.dynamic_behavior else None,
            'threat_level': self.threat_level.value,
            'overall_score': self.overall_score,
            'malware_family': self.malware_family,
            'tags': self.tags,
            'notes': self.notes
        }

    def to_json(self, indent: int = 2) -> str:
        """Convert to JSON string"""
        return json.dumps(self.to_dict(), indent=indent)

    def save_report(self, output_path: str):
        """Save analysis report to file"""
        with open(output_path, 'w') as f:
            f.write(self.to_json())
