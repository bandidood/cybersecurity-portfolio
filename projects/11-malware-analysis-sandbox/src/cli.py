#!/usr/bin/env python3
"""
Malware Analysis Sandbox - Command Line Interface
Main CLI for malware analysis operations
"""

import argparse
import sys
import os
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.models import AnalysisStatus
from src.analyzers.static_analyzer import StaticAnalyzer
from src.scanners.yara_scanner import YARAScanner, save_default_rules
from src.utils.sample_manager import SampleManager
from src.utils.report_generator import ReportGenerator


class MalwareAnalysisCLI:
    """Command-line interface for malware analysis sandbox"""

    def __init__(self):
        self.analyzer = StaticAnalyzer()
        self.manager = SampleManager()
        self.yara_scanner = None
        self.parser = self._create_parser()

    def _create_parser(self) -> argparse.ArgumentParser:
        """Create argument parser"""
        parser = argparse.ArgumentParser(
            description="Malware Analysis Sandbox CLI",
            formatter_class=argparse.RawDescriptionHelpFormatter
        )

        subparsers = parser.add_subparsers(dest='command', help='Available commands')

        # Analyze command
        analyze_parser = subparsers.add_parser('analyze', help='Analyze a malware sample')
        analyze_parser.add_argument('file', help='Path to file to analyze')
        analyze_parser.add_argument('--yara-rules', help='Path to YARA rules directory')
        analyze_parser.add_argument('--output', '-o', help='Output report path')
        analyze_parser.add_argument('--format', choices=['text', 'markdown', 'json'],
                                    default='text', help='Report format')
        analyze_parser.add_argument('--import', dest='import_sample', action='store_true',
                                    help='Import sample into sandbox')

        # Import command
        import_parser = subparsers.add_parser('import', help='Import sample into sandbox')
        import_parser.add_argument('file', help='Path to file to import')
        import_parser.add_argument('--tags', nargs='+', help='Tags for the sample')
        import_parser.add_argument('--notes', help='Notes about the sample')
        import_parser.add_argument('--move', action='store_true', help='Move file instead of copy')

        # List command
        list_parser = subparsers.add_parser('list', help='List samples in sandbox')
        list_parser.add_argument('--status', choices=['pending', 'running', 'completed', 'failed'],
                                 help='Filter by status')
        list_parser.add_argument('--tags', nargs='+', help='Filter by tags')
        list_parser.add_argument('--limit', type=int, default=50, help='Maximum results')

        # Report command
        report_parser = subparsers.add_parser('report', help='Generate report for sample')
        report_parser.add_argument('sample_id', help='Sample ID')
        report_parser.add_argument('--output', '-o', help='Output report path')
        report_parser.add_argument('--format', choices=['text', 'markdown', 'json'],
                                   default='text', help='Report format')

        # Search command
        search_parser = subparsers.add_parser('search', help='Search samples')
        search_parser.add_argument('query', help='Search query')
        search_parser.add_argument('--limit', type=int, default=20, help='Maximum results')

        # Delete command
        delete_parser = subparsers.add_parser('delete', help='Delete sample')
        delete_parser.add_argument('sample_id', help='Sample ID')
        delete_parser.add_argument('--keep-file', action='store_true',
                                   help='Keep sample file, only delete metadata')

        # Stats command
        subparsers.add_parser('stats', help='Show sandbox statistics')

        # YARA commands
        yara_parser = subparsers.add_parser('yara', help='YARA rule operations')
        yara_subparsers = yara_parser.add_subparsers(dest='yara_command')

        # YARA scan
        yara_scan_parser = yara_subparsers.add_parser('scan', help='Scan file with YARA rules')
        yara_scan_parser.add_argument('file', help='File to scan')
        yara_scan_parser.add_argument('--rules', required=True, help='YARA rules directory or file')

        # YARA init
        yara_init_parser = yara_subparsers.add_parser('init', help='Initialize default YARA rules')
        yara_init_parser.add_argument('--output', default='rules', help='Output directory')

        return parser

    def run(self, args=None):
        """Run CLI with arguments"""
        args = self.parser.parse_args(args)

        if not args.command:
            self.parser.print_help()
            return

        # Execute command
        command_method = getattr(self, f'cmd_{args.command}', None)
        if command_method:
            command_method(args)
        else:
            print(f"Unknown command: {args.command}")
            sys.exit(1)

    def cmd_analyze(self, args):
        """Analyze malware sample"""
        print(f"Analyzing: {args.file}")
        print("-" * 80)

        # Perform static analysis
        try:
            result = self.analyzer.analyze_file(args.file)

            # YARA scanning if rules provided
            if args.yara_rules:
                print("Running YARA scan...")
                scanner = YARAScanner(args.yara_rules)
                yara_matches = scanner.scan_file(args.file)
                result.yara_matches = yara_matches
                print(f"  YARA Matches: {len(yara_matches)}")

            # Print summary
            print(f"\nAnalysis Complete:")
            print(f"  Sample Type: {result.sample_type.value}")
            print(f"  Threat Level: {result.threat_level.value.upper()}")
            print(f"  Threat Score: {result.threat_score:.1f}/100")
            print(f"  Analysis Time: {result.analysis_time:.2f}s")

            if result.family:
                print(f"  Family: {result.family}")

            if result.tags:
                print(f"  Tags: {', '.join(result.tags)}")

            # Create sample object
            from src.models import MalwareSample
            sample = MalwareSample.from_file(args.file)
            sample.static_analysis = result
            sample.threat_level = result.threat_level
            sample.overall_score = result.threat_score
            sample.malware_family = result.family
            sample.tags = result.tags
            sample.status = AnalysisStatus.COMPLETED

            # Import into sandbox if requested
            if args.import_sample:
                print("\nImporting into sandbox...")
                sample = self.manager.import_sample(args.file, tags=result.tags)
                sample.static_analysis = result
                sample.status = AnalysisStatus.COMPLETED
                self.manager.update_sample(sample)
                print(f"  Sample ID: {sample.sample_id}")

            # Generate report if output specified
            if args.output:
                ReportGenerator.save_report(sample, args.output, args.format)
            else:
                # Print text report to console
                report = ReportGenerator.generate_text_report(sample)
                print("\n")
                print(report)

        except Exception as e:
            print(f"Error analyzing file: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)

    def cmd_import(self, args):
        """Import sample into sandbox"""
        print(f"Importing sample: {args.file}")

        try:
            sample = self.manager.import_sample(
                args.file,
                tags=args.tags,
                notes=args.notes or "",
                move=args.move
            )

            print(f"✓ Sample imported successfully")
            print(f"  Sample ID: {sample.sample_id}")
            print(f"  Filename: {sample.file_info.filename}")
            print(f"  Size: {sample.file_info.size:,} bytes")
            print(f"  SHA256: {sample.file_info.sha256}")

            if args.tags:
                print(f"  Tags: {', '.join(args.tags)}")

        except Exception as e:
            print(f"Error importing sample: {e}")
            sys.exit(1)

    def cmd_list(self, args):
        """List samples in sandbox"""
        # Convert status string to enum
        status = AnalysisStatus(args.status) if args.status else None

        samples = self.manager.list_samples(
            status=status,
            tags=args.tags,
            limit=args.limit
        )

        if not samples:
            print("No samples found.")
            return

        print(f"\nSamples ({len(samples)} found):\n")
        print(f"{'Sample ID':<18} {'Filename':<30} {'Status':<12} {'Threat':<10} {'Tags'}")
        print("-" * 100)

        for sample in samples:
            sample_id = sample['sample_id']
            filename = sample['file_info']['filename'][:28]
            status = sample['status']
            threat = sample.get('threat_level', 'unknown')
            tags = ', '.join(sample.get('tags', [])[:3])

            print(f"{sample_id:<18} {filename:<30} {status:<12} {threat:<10} {tags}")

    def cmd_report(self, args):
        """Generate report for sample"""
        sample = self.manager.get_sample(args.sample_id)

        if not sample:
            print(f"Sample not found: {args.sample_id}")
            sys.exit(1)

        if args.output:
            ReportGenerator.save_report(sample, args.output, args.format)
        else:
            if args.format == 'text':
                report = ReportGenerator.generate_text_report(sample)
            elif args.format == 'markdown':
                report = ReportGenerator.generate_markdown_report(sample)
            elif args.format == 'json':
                report = sample.to_json()

            print(report)

    def cmd_search(self, args):
        """Search samples"""
        results = self.manager.search_samples(args.query, limit=args.limit)

        if not results:
            print(f"No samples found matching '{args.query}'")
            return

        print(f"\nSearch Results ({len(results)} found):\n")
        print(f"{'Sample ID':<18} {'Filename':<30} {'Threat':<12} {'Family'}")
        print("-" * 100)

        for sample in results:
            sample_id = sample['sample_id']
            filename = sample['file_info']['filename'][:28]
            threat = sample.get('threat_level', 'unknown')
            family = sample.get('malware_family', '-')

            print(f"{sample_id:<18} {filename:<30} {threat:<12} {family}")

    def cmd_delete(self, args):
        """Delete sample"""
        self.manager.delete_sample(
            args.sample_id,
            delete_file=not args.keep_file
        )

        print(f"✓ Sample deleted: {args.sample_id}")

    def cmd_stats(self, args):
        """Show sandbox statistics"""
        stats = self.manager.get_statistics()

        print("\nSandbox Statistics:\n")
        print(f"Total Samples: {stats['total_samples']}")
        print(f"Total Size: {stats['total_size_bytes']:,} bytes ({stats['total_size_bytes'] / 1024 / 1024:.2f} MB)")

        print("\nBy Status:")
        for status, count in stats['by_status'].items():
            print(f"  {status:12}: {count}")

        if stats['oldest_sample']:
            print(f"\nOldest Sample: {stats['oldest_sample']}")
            print(f"Newest Sample: {stats['newest_sample']}")

    def cmd_yara(self, args):
        """YARA rule operations"""
        if args.yara_command == 'scan':
            self._yara_scan(args)
        elif args.yara_command == 'init':
            self._yara_init(args)
        else:
            print("Unknown YARA command")

    def _yara_scan(self, args):
        """Scan file with YARA rules"""
        print(f"Scanning: {args.file}")
        print(f"Rules: {args.rules}")
        print("-" * 80)

        try:
            scanner = YARAScanner(args.rules)
            matches = scanner.scan_file(args.file)

            if not matches:
                print("No YARA matches found.")
                return

            print(f"\n{len(matches)} YARA rule(s) matched:\n")

            for match in matches:
                print(f"Rule: {match.rule_name}")
                if match.tags:
                    print(f"  Tags: {', '.join(match.tags)}")
                if match.meta:
                    print(f"  Meta:")
                    for key, value in match.meta.items():
                        print(f"    {key}: {value}")
                if match.strings:
                    print(f"  Matched Strings: {len(match.strings)}")
                    for s in match.strings[:3]:
                        print(f"    {s['identifier']} at offset {s['offset']}")
                print()

        except ImportError:
            print("Error: yara-python is not installed")
            print("Install with: pip install yara-python")
            sys.exit(1)
        except Exception as e:
            print(f"Error scanning file: {e}")
            sys.exit(1)

    def _yara_init(self, args):
        """Initialize default YARA rules"""
        print(f"Initializing default YARA rules in: {args.output}")

        try:
            save_default_rules(args.output)
            print(f"\n✓ Default YARA rules saved to {args.output}/")
            print(f"\nUse with: malware-cli yara scan <file> --rules {args.output}")

        except Exception as e:
            print(f"Error initializing rules: {e}")
            sys.exit(1)


def main():
    """Main entry point"""
    cli = MalwareAnalysisCLI()
    cli.run()


if __name__ == '__main__':
    main()
