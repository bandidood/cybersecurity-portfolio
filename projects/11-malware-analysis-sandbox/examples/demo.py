#!/usr/bin/env python3
"""
Malware Analysis Sandbox - Demonstration Script
Shows complete workflow of the malware analysis sandbox
"""

import sys
import os
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.analyzers.static_analyzer import StaticAnalyzer
from src.scanners.yara_scanner import YARAScanner, save_default_rules, get_default_rules
from src.utils.sample_manager import SampleManager
from src.utils.report_generator import ReportGenerator
from src.models import MalwareSample, AnalysisStatus


def print_header(title: str):
    """Print formatted section header"""
    print("\n" + "="*80)
    print(f" {title}")
    print("="*80 + "\n")


def demo_static_analysis():
    """Demonstrate static analysis capabilities"""
    print_header("1. Static Analysis Demonstration")

    print("The static analyzer can extract:")
    print("  • File metadata (hashes, size, type)")
    print("  • PE structure (sections, imports, exports)")
    print("  • Embedded strings (URLs, IPs, paths, registry keys)")
    print("  • Entropy and packing detection")
    print("  • Suspicious API calls")
    print("  • Threat scoring and classification")

    print("\nExample usage:")
    print("""
    from src.analyzers.static_analyzer import StaticAnalyzer

    analyzer = StaticAnalyzer()
    result = analyzer.analyze_file('suspicious.exe')

    print(f"Threat Level: {result.threat_level.value}")
    print(f"Threat Score: {result.threat_score}/100")
    print(f"Indicators: {result.indicators}")
    """)

    print("\nCapabilities:")
    print("  ✓ PE/ELF/Mach-O format analysis")
    print("  ✓ String extraction and categorization")
    print("  ✓ Packer detection (UPX, ASPack, etc.)")
    print("  ✓ Entropy calculation")
    print("  ✓ Import/Export table analysis")
    print("  ✓ Resource extraction")
    print("  ✓ Automated threat scoring")


def demo_yara_scanning():
    """Demonstrate YARA scanning"""
    print_header("2. YARA Rule Scanner")

    print("YARA scanner features:")
    print("  • Load rules from files or directories")
    print("  • Scan files and data buffers")
    print("  • Extract matched strings and offsets")
    print("  • Custom rule creation")

    print("\nDefault rules included:")
    rules = get_default_rules()
    for rule_name in rules.keys():
        print(f"  • {rule_name}")

    print("\nExample usage:")
    print("""
    from src.scanners.yara_scanner import YARAScanner

    # Initialize with rules
    scanner = YARAScanner('rules/')
    matches = scanner.scan_file('malware.exe')

    for match in matches:
        print(f"Rule: {match.rule_name}")
        print(f"Tags: {match.tags}")
        print(f"Meta: {match.meta}")
    """)

    print("\nInitialize default rules with CLI:")
    print("  $ python src/cli.py yara init --output rules/")


def demo_sample_management():
    """Demonstrate sample management"""
    print_header("3. Sample Management System")

    print("Sample manager provides:")
    print("  • Secure sample storage")
    print("  • Metadata tracking")
    print("  • Status management (pending/analyzed/quarantine)")
    print("  • Search and filtering")
    print("  • Sample import/export")
    print("  • Statistics and reporting")

    print("\nExample usage:")
    print("""
    from src.utils.sample_manager import SampleManager

    manager = SampleManager()

    # Import sample
    sample = manager.import_sample(
        'malware.exe',
        tags=['ransomware', 'high-priority'],
        notes='Received from SOC team'
    )

    # List samples
    samples = manager.list_samples(status=AnalysisStatus.PENDING)

    # Search
    results = manager.search_samples('ransomware')

    # Get statistics
    stats = manager.get_statistics()
    """)


def demo_report_generation():
    """Demonstrate report generation"""
    print_header("4. Report Generation")

    print("Report generator supports:")
    print("  • Text format (detailed, human-readable)")
    print("  • Markdown format (for documentation)")
    print("  • JSON format (for automation)")

    print("\nReport includes:")
    print("  • Executive summary")
    print("  • File hashes and metadata")
    print("  • PE structure details")
    print("  • Extracted strings and IOCs")
    print("  • YARA rule matches")
    print("  • Threat assessment")
    print("  • Recommended actions")

    print("\nExample usage:")
    print("""
    from src.utils.report_generator import ReportGenerator

    # Generate text report
    report = ReportGenerator.generate_text_report(sample)
    print(report)

    # Save to file
    ReportGenerator.save_report(sample, 'report.txt', format='text')
    ReportGenerator.save_report(sample, 'report.md', format='markdown')
    ReportGenerator.save_report(sample, 'report.json', format='json')
    """)


def demo_cli_usage():
    """Demonstrate CLI usage"""
    print_header("5. Command-Line Interface")

    print("The CLI provides complete sandbox control:\n")

    commands = [
        ("analyze <file>", "Perform static analysis on a file"),
        ("  --yara-rules <path>", "Include YARA scanning"),
        ("  --output <file>", "Save report to file"),
        ("  --import", "Import sample into sandbox"),
        ("", ""),
        ("import <file>", "Import sample into sandbox"),
        ("  --tags <tags>", "Add tags to sample"),
        ("  --notes <text>", "Add notes"),
        ("  --move", "Move file instead of copy"),
        ("", ""),
        ("list", "List all samples"),
        ("  --status <status>", "Filter by status"),
        ("  --tags <tags>", "Filter by tags"),
        ("", ""),
        ("search <query>", "Search samples by keyword"),
        ("", ""),
        ("report <sample_id>", "Generate report for sample"),
        ("  --format <fmt>", "Report format (text/markdown/json)"),
        ("", ""),
        ("yara init", "Initialize default YARA rules"),
        ("yara scan <file>", "Scan file with YARA"),
        ("  --rules <path>", "Rules directory/file"),
        ("", ""),
        ("stats", "Show sandbox statistics"),
        ("delete <sample_id>", "Delete sample"),
    ]

    for cmd, desc in commands:
        if cmd:
            print(f"  {cmd:<30} {desc}")
        else:
            print()

    print("\nExamples:")
    print("""
    # Analyze a file
    $ python src/cli.py analyze suspicious.exe --output report.txt

    # Analyze with YARA
    $ python src/cli.py analyze malware.dll --yara-rules rules/ --import

    # List all samples
    $ python src/cli.py list --status completed

    # Search for ransomware
    $ python src/cli.py search ransomware

    # Generate report
    $ python src/cli.py report abc123def456 --format markdown

    # Initialize YARA rules
    $ python src/cli.py yara init --output rules/

    # Scan with YARA
    $ python src/cli.py yara scan file.exe --rules rules/
    """)


def demo_integration_workflow():
    """Demonstrate complete integration workflow"""
    print_header("6. Complete Analysis Workflow")

    print("Typical malware analysis workflow:\n")

    steps = [
        ("1. Sample Reception", [
            "Receive suspicious file from SOC/incident response",
            "Import into sandbox with metadata",
            "Tag and categorize based on source"
        ]),
        ("2. Static Analysis", [
            "Extract file metadata and hashes",
            "Analyze PE structure and imports",
            "Extract strings and IOCs",
            "Calculate threat score"
        ]),
        ("3. YARA Scanning", [
            "Scan with signature database",
            "Identify known malware families",
            "Extract rule metadata and tags"
        ]),
        ("4. Report Generation", [
            "Compile analysis results",
            "Generate IOC list",
            "Create executive summary",
            "Export in required format"
        ]),
        ("5. Response Actions", [
            "Update IDS/IPS signatures",
            "Block IOCs in firewall/proxy",
            "Share intelligence with team",
            "Archive sample for future reference"
        ])
    ]

    for step_name, actions in steps:
        print(f"{step_name}:")
        for action in actions:
            print(f"  • {action}")
        print()


def demo_security_considerations():
    """Demonstrate security features"""
    print_header("7. Security Features & Best Practices")

    print("Built-in security measures:")
    print("  • Isolated sample storage")
    print("  • Separate directories for different statuses")
    print("  • Quarantine capability for high-risk samples")
    print("  • No automatic code execution")
    print("  • Safe string extraction")
    print("  • Entropy-based packing detection")

    print("\nBest practices:")
    print("  1. Run sandbox in isolated VM/container")
    print("  2. Use network isolation for dynamic analysis")
    print("  3. Regularly update YARA rules")
    print("  4. Validate all samples before analysis")
    print("  5. Maintain separate production/analysis environments")
    print("  6. Use proper access controls for sample storage")
    print("  7. Implement logging and audit trails")
    print("  8. Regular backups of analysis results")

    print("\nQuarantine workflow:")
    print("""
    from src.utils.sample_manager import SampleManager

    manager = SampleManager()

    # Move high-risk sample to quarantine
    manager.quarantine_sample('abc123def456')

    # Sample is now isolated in quarantine directory
    # Only accessible with explicit permissions
    """)


def main():
    """Run complete demonstration"""
    print("\n" + "="*80)
    print(" MALWARE ANALYSIS SANDBOX - COMPREHENSIVE DEMONSTRATION")
    print("="*80)

    # Run demonstrations
    demo_static_analysis()
    demo_yara_scanning()
    demo_sample_management()
    demo_report_generation()
    demo_cli_usage()
    demo_integration_workflow()
    demo_security_considerations()

    # Final summary
    print_header("Demonstration Complete")
    print("This demonstration showcased:")
    print("  ✓ Static malware analysis capabilities")
    print("  ✓ YARA rule scanning and detection")
    print("  ✓ Sample management and organization")
    print("  ✓ Comprehensive report generation")
    print("  ✓ Command-line interface usage")
    print("  ✓ Complete analysis workflows")
    print("  ✓ Security features and best practices")

    print("\nTo get started:")
    print("  1. Install dependencies: pip install -r requirements.txt")
    print("  2. Initialize YARA rules: python src/cli.py yara init")
    print("  3. Analyze a file: python src/cli.py analyze <file>")
    print("  4. Review generated reports")

    print("\nFor production deployment:")
    print("  • Run in isolated VM or container")
    print("  • Configure network isolation")
    print("  • Set up proper access controls")
    print("  • Integrate with SIEM/SOC workflows")
    print("  • Regular YARA rule updates")
    print("  • Implement retention policies")

    print("\n" + "="*80)


if __name__ == "__main__":
    main()
